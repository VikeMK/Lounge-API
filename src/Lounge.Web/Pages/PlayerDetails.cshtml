@page "/{game}/PlayerDetails/{id:int}"
@using Lounge.Web.Models.ViewModels
@using Lounge.Web.Models.Enums
@using Lounge.Web.Settings
@using Lounge.Web.Utils
@using Microsoft.AspNetCore.Mvc.Localization
@using System.Linq
@inject ILoungeSettingsService LoungeSettingsService
@inject IViewLocalizer Localizer
@model Lounge.Web.Pages.PlayerDetailsPageModel
@{
    ViewData["Title"] = $"{Model.Data.Name} - {Model.Data.SeasonDisplayName}";
    Layout = "_Layout";
}

@await Html.PartialAsync("Shared/_SeasonSelectorPartial", new Lounge.Web.Models.ViewModels.SeasonSelectorModel {
    PageName = "PlayerDetails",
    Game = Model.Data.Game,
    PlayerId = Model.Data.PlayerId,
    CurrentSeason = Model.Data.Season,
    ValidSeasons = Model.Data.ValidSeasons ?? new List<int>()
})

<h1>@Model.Data.Name - @Html.DisplayFor(model => model.Data.Rank) @(Model.Data.IsHidden ? $"({Localizer["Hidden"]})" : string.Empty)</h1>
@if (Model.OtherGameRegistered)
{
    <div>
        <a asp-page="PlayerDetails" asp-route-game="@Model.OtherGame.GetStringId()" asp-route-id="@Model.Data.PlayerId">
            Go to @(Model.OtherGame == Game.mk8dx ? "MK8DX" : "MKWorld") profile
        </a>
    </div>
}
<hr />

<div>
    <div id="details-section">
        <dl class="row mx-0">
            <div class="col-lg-3 col-md-4 col-sm-6 col-xs-6">
                <dt>@Localizer[Html.DisplayNameFor(model => model.Data.OverallRank)]</dt>
                <dd>@Html.DisplayFor(model => model.Data.OverallRank)</dd>
            </div>
            <div class="col-lg-3 col-md-4 col-sm-6 col-xs-6">
                <dt>@Localizer[Html.DisplayNameFor(model => model.Data.Mmr)]</dt>
                <dd class="rank-@Model.Data.RankData.Division">@Html.DisplayFor(model => model.Data.Mmr)</dd>
            </div>
            <div class="col-lg-3 col-md-4 col-sm-6 col-xs-6">
                <dt>@Localizer[Html.DisplayNameFor(model => model.Data.MaxMmr)]</dt>
                <dd class="rank-@LoungeSettingsService.GetRank(Model.Data.MaxMmr, Model.Data.Game, Model.Data.Season).Division">@Html.DisplayFor(model => model.Data.MaxMmr)</dd>
            </div>
            @if(Model.Data.RegistryLink != null)
            {
                <div class="col-lg-3 col-md-4 col-sm-6 col-xs-6">
                    <dt>@Localizer[Html.DisplayNameFor(model => model.Data.RegistryLink)]</dt>
                    <dd><a href="@Model.Data.RegistryLink">Link</a></dd>
                </div>
            }
            <div class="col-lg-3 col-md-4 col-sm-6 col-xs-6">
                <dt>@Localizer[Html.DisplayNameFor(model => model.Data.CountryName)]</dt>
                <dd>@Html.DisplayFor(model => model.Data.CountryName)</dd>
            </div>
            <div class="col-lg-3 col-md-4 col-sm-6 col-xs-6">
                <dt>@Localizer[Html.DisplayNameFor(model => model.Data.EventsPlayed)]</dt>
                <dd>@Html.DisplayFor(model => model.Data.EventsPlayed)</dd>
            </div>
        </dl>
        <br />
        @{
            var roomSizeStatsDict = Model.Data.GetRoomSizeStats();
        }
        @if (roomSizeStatsDict != null && roomSizeStatsDict.Any())
        {
            foreach (var kvp in roomSizeStatsDict.OrderBy(x => x.Key))
            {
                var roomSize = kvp.Key;
                var roomSizeStats = kvp.Value;
                <h3>@roomSize Player Events</h3>
                <dl class="row mx-0">
                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-6">
                        <dt>@Localizer[Html.DisplayNameFor(model => roomSizeStats.EventsPlayed)]</dt>
                        <dd>@Html.DisplayFor(model => roomSizeStats.EventsPlayed)</dd>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-6">
                        <dt>@Localizer[Html.DisplayNameFor(model => roomSizeStats.WinRate)]</dt>
                        <dd>@Html.DisplayFor(model => roomSizeStats.WinRate)</dd>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-6">
                        <dt>@Localizer["Win - Loss (Last 10)"]</dt>
                        <dd>@Html.DisplayFor(model => roomSizeStats.LastTenWins) - @Html.DisplayFor(model => roomSizeStats.LastTenLosses)</dd>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-6">
                        <dt>@Localizer["Gain/Loss (Last 10)"]</dt>
                        <dd>@Html.DisplayFor(model => roomSizeStats.LastTenGainLoss)</dd>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-6">
                        <dt>@Localizer["Largest Gain"]</dt>
                        <dd>
                            @{
                                var gain = roomSizeStats.LargestGain;
                            }
                            @(gain.HasValue ? gain.Value.Amount.ToString() : "-")
                        </dd>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-6">
                        <dt>@Localizer["Average Score"]</dt>
                        <dd>@Html.DisplayFor(model => roomSizeStats.AverageScore)</dd>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-6">
                        <dt>@Localizer["Average Score (No SQ)"]</dt>
                        <dd>@Html.DisplayFor(model => roomSizeStats.NoSQAverageScore)</dd>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-6">
                        <dt>@Localizer["Average Score (Last 10)"]</dt>
                        <dd>@Html.DisplayFor(model => roomSizeStats.AverageLastTen)</dd>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-6">
                        <dt>@Localizer["Partner Average Score"]</dt>
                        <dd>@Html.DisplayFor(model => roomSizeStats.PartnerAverage)</dd>
                    </div>
                    <div class="col-lg-3 col-md-4 col-sm-6 col-xs-6">
                        <dt>@Localizer["Partner Average Score (No SQ)"]</dt>
                        <dd>@Html.DisplayFor(model => roomSizeStats.NoSQPartnerAverage)</dd>
                    </div>
                </dl>
                <br />
            }
        }
        else
        {
            <p>No room size stats available.</p>
        }
    </div>
    @if (Model.Data.MmrChanges.Count > 0)
    {
        <div class="table-responsive">
            <table class="table table-striped table-dark">
                <thead>
                    <tr>
                        <th>@Localizer[Html.DisplayNameFor(model => model.Data.MmrChanges[0].Reason)]</th>
                        <th>@Localizer[@Html.DisplayNameFor(model => model.Data.MmrChanges[0].Time)]</th>
                        <th>@Localizer[Html.DisplayNameFor(model => model.Data.MmrChanges[0].MmrDelta)]</th>
                        <th>@Localizer[Html.DisplayNameFor(model => model.Data.MmrChanges[0].NewMmr)]</th>
                    </tr>
                </thead>
                @foreach (var change in Model.Data.MmrChanges)
                {
                    <tr>
                        <td>
                            @if (change.Reason is PlayerDetailsViewModel.MmrChangeReason.Table)
                            {
                                var numPlayers = change.NumPlayers ?? 12;
                                var roomSizeFormat = Model.Data.Game == Game.mk8dx ? "" : $"{numPlayers}P ";
                                var tierFormat = Model.Data.Game == Game.mkworld && change.Tier == "Q" ? "" : (TableUtils.TierDisplayName(change.Tier) + " ");
                                <a asp-page="TableDetails" asp-route-game="@Model.Data.Game.GetStringId()" asp-route-id="@change.ChangeId">@tierFormat@roomSizeFormat@TableUtils.FormatDisplay(change.NumTeams!.Value, numPlayers) (ID: @change.ChangeId)</a>
                            }
                            else if (change.Reason is PlayerDetailsViewModel.MmrChangeReason.TableDelete)
                            {
                                <a asp-page="TableDetails" asp-route-game="@Model.Data.Game.GetStringId()" asp-route-id="@change.ChangeId">@Localizer[Html.DisplayTextFor(modelItem => change.Reason)] (ID: @change.ChangeId)</a>
                            }
                            else
                            {
                                @Localizer[Html.DisplayTextFor(modelItem => change.Reason)]
                            }
                        </td>
                        <td>
                            <span class="utc-to-local" data-time="@change.Time.ToString("o", System.Globalization.CultureInfo.InvariantCulture)">
                                @Html.DisplayFor(modelItem => change.Time)
                            </span>
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => change.MmrDelta)
                        </td>
                        <td class="rank-@LoungeSettingsService.GetRank(change.NewMmr, Model.Data.Game, Model.Data.Season)!.Division">
                            @Html.DisplayFor(modelItem => change.NewMmr)
                        </td>
                    </tr>
                }
            </table>
        </div>
    }
</div>