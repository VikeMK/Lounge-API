@page "/{game}/Records"
@using Lounge.Web.Models.Enums
@using Lounge.Web.Settings
@using Lounge.Web.Utils
@using Microsoft.AspNetCore.Mvc.Localization
@inject ILoungeSettingsService LoungeSettingsService
@inject IViewLocalizer Localizer
@model Lounge.Web.Pages.RecordsPageModel
@{
    ViewData["Title"] = $"{Localizer.GetString("Records")} - {GameUtils.GetSeasonDisplayName(Model.Season)}";
    Layout = "_Layout";
    var resultsToShow = 5;
}

@await Html.PartialAsync("Shared/_SeasonSelectorPartial", new Lounge.Web.Models.ViewModels.SeasonSelectorModel {
    PageName = "Records",
    Game = Model.Game,
    CurrentSeason = Model.Season,
    ValidSeasons = Model.ValidSeasons,
    PlayerCount = Model.Game == GameMode.mkworld12p ? 12 : Model.Game == GameMode.mkworld24p ? 24 : null
})

<div>
    @{
        var numPlayers = 12;
        var teamCounts = new List<int> { 12, 6, 4, 3, 2 };
        if (Model.Game == GameMode.mkworld24p)
        {
            numPlayers = 24;
            teamCounts.Insert(0, 24);
        }
    }
    @foreach (var teamCount in teamCounts)
    {
        @if ((Model.Game != GameMode.mk8dx || Model.Season > 4) && teamCount == 2)
        {
            continue;
        }

        <h2>@TableUtils.FormatDisplay(teamCount, numPlayers)</h2>
        <div class="row mb-4">
            @foreach (var tier in LoungeSettingsService.RecordsTierOrders[Model.Game][Model.Season])
            {
                var tierRecords = Model.Records.Tiers.TryGetValue(tier, out var x) ? x : null;
                var formatRecords = tierRecords?.TeamCounts.TryGetValue(teamCount, out var y) == true ? y : null;
                <div class="col-lg-3 col-md-4 col-6 table-responsive">
                    <h5>Tier @tier</h5>
                    <table class="table table-striped table-dark table-sm">
                        <thead>
                            <tr>
                                <th>🏆</th>
                                <th>@Localizer["Players"]</th>
                                <th>🏁</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if(formatRecords != null)
                            {
                                var prevScore = -1;
                                var prevRank = 0;
                                var rank = 1;
                                @foreach (var record in formatRecords.Results.Take(resultsToShow))
                                {
                                    var actualRank = record.TotalScore == prevScore ? prevRank : rank;
                                    rank++;
                                    <tr>
                                        <td class="align-middle px-1">@(actualRank switch { 1 => "🥇", 2 => "🥈", 3 => "🥉", int n => $"{n}ᵗʰ" })</td>
                                        <td>
                                            @foreach (var player in record.Players)
                                            {
                                                if (player != record.Players[0])
                                                {
                                                    <br />
                                                }
                                                <!-- Put p in route values for MKWorld -->
                                                <a asp-page="PlayerDetails" asp-route-game="@Model.Game.GetRegistrationGameMode().GetStringId()" asp-route-id="@player.Id" asp-route-season="@Model.Season">@player.Name</a>
                                            }
                                        </td>
                                        <td class="align-middle px-1">
                                            <a asp-page="TableDetails" asp-route-game="@Model.Game.GetRegistrationGameMode().GetStringId()" asp-route-id="@record.TableId">@record.TotalScore</a>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="3">@Localizer["No tables found"]</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    }
</div>